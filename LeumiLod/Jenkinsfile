pipeline {
    agent any

    environment {
        DOCKER_BIN = '/var/jenkins_home/.local/bin/docker'
        MINIKUBE_BIN = '/var/jenkins_home/.local/bin/minikube'
        KUBECTL_BIN = '/var/jenkins_home/.local/bin/kubectl'
    }

    stages {
        stage('Setup Docker and Minikube') {
            steps {
                script {
                    // Ensure Docker is installed and running
                    sh '''
                        if ! command -v docker > /dev/null; then
                            echo "Docker not found. Installing Docker..."
                            curl -LO https://download.docker.com/linux/static/stable/x86_64/docker-20.10.24.tgz
                            tar xzvf docker-20.10.24.tgz
                            mv docker/* /var/jenkins_home/.local/bin/
                        fi

                        if ! docker info > /dev/null 2>&1; then
                            echo "Docker is not running. Starting Docker..."
                            sudo systemctl start docker
                        fi

                        docker --version
                        docker run hello-world
                    '''
                    
                    // Ensure Minikube and kubectl are installed
                    sh '''
                        if ! command -v minikube > /dev/null; then
                            echo "Minikube not found. Installing Minikube..."
                            curl -LO https://storage.googleapis.com/minikube/releases/v1.29.0/minikube-linux-amd64
                            mkdir -p /var/jenkins_home/.local/bin
                            mv minikube-linux-amd64 /var/jenkins_home/.local/bin/minikube
                            chmod +x /var/jenkins_home/.local/bin/minikube
                        fi

                        if ! command -v kubectl > /dev/null; then
                            echo "kubectl not found. Installing kubectl..."
                            curl -LO https://dl.k8s.io/release/v1.26.0/bin/linux/amd64/kubectl
                            mv kubectl /var/jenkins_home/.local/bin/kubectl
                            chmod +x /var/jenkins_home/.local/bin/kubectl
                        fi

                        minikube version
                        kubectl version --client
                    '''
                }
            }
        }

        stage('Check Docker Daemon') {
            steps {
                script {
                    sh '''
                        if ! pgrep -x "dockerd" > /dev/null; then
                            echo "Docker daemon not running. Starting Docker..."
                            sudo systemctl start docker
                        else
                            echo "Docker daemon is running."
                        fi
                    '''
                }
            }
        }

        stage('Validate Docker Installation') {
            steps {
                script {
                    sh '''
                        docker --version
                        docker run hello-world
                    '''
                }
            }
        }

        stage('Checkout SCM') {
            steps {
                checkout([$class: 'GitSCM',
                          branches: [[name: '*/main']],
                          userRemoteConfigs: [[url: 'https://github.com/Guy-BP/projects']]
                ])
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    sh '''
                        cd LeumiLod
                        if [ ! -f Dockerfile ]; then
                            echo "Dockerfile not found. Exiting."
                            exit 1
                        fi
                        docker build -t my-app:latest .
                    '''
                }
            }
        }

        stage('Deploy to Minikube') {
            steps {
                script {
                    sh '''
                        if ! minikube status | grep -q "host: Running"; then
                            echo "Minikube is not running. Starting Minikube..."
                            minikube start
                        fi
                        kubectl apply -f deployment.yaml
                    '''
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
