pipeline {
    agent any

    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    // Build Docker image
                    sh '''
                    if command -v docker &> /dev/null
                    then
                        echo "Building Docker image..."
                        docker build -t my-docker-image .
                    else
                        echo "Docker is not installed. Please install Docker."
                        exit 1
                    fi
                    '''
                }
            }
        }

        stage('Install Minikube & kubectl') {
            steps {
                script {
                    // Install Minikube and kubectl if not installed
                    sh '''
                    if command -v minikube &> /dev/null
                    then
                        echo "Minikube is already installed."
                    else
                        echo "Minikube is not installed. Please install Minikube."
                        exit 1
                    fi

                    if command -v kubectl &> /dev/null
                    then
                        echo "kubectl is already installed."
                    else
                        echo "kubectl is not installed. Please install kubectl."
                        exit 1
                    fi
                    '''
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                script {
                    // Deploy to Kubernetes cluster
                    sh '''
                    if command -v kubectl &> /dev/null
                    then
                        echo "Starting Minikube and applying Kubernetes manifests..."
                        minikube start
                        kubectl apply -f k8s/deployment.yaml
                    else
                        echo "kubectl is not installed. Please install kubectl."
                        exit 1
                    fi
                    '''
                }
            }
        }

        stage('Expose Service') {
            steps {
                script {
                    // Expose service
                    sh '''
                    if command -v kubectl &> /dev/null
                    then
                        echo "Exposing service..."
                        kubectl expose deployment your-deployment --type=LoadBalancer --name=your-service
                    else
                        echo "kubectl is not installed. Please install kubectl."
                        exit 1
                    fi
                    '''
                }
            }
        }
    }

    post {
        always {
            // Clean up workspace after build
            cleanWs()
        }
    }
}
