pipeline {
    agent any

    environment {
        DOCKER_IMAGE_NAME = 'simple-flask-app'
        DOCKER_IMAGE_TAG = 'latest'
    }

    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                script {
                    // Install necessary packages and Docker
                    sh '''
                        # Update package list
                        apt-get update -qq

                        # Install necessary packages
                        apt-get install -y curl apt-transport-https gnupg

                        # Add Docker's official GPG key
                        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -

                        # Set up the stable repository
                        echo "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

                        # Update package list again
                        apt-get update -qq

                        # Install Docker
                        apt-get install -y docker-ce docker-ce-cli containerd.io

                        # Start Docker service
                        systemctl start docker || true

                        # Verify Docker installation
                        docker --version || echo "Docker installation failed"

                        # Install kubectl
                        if ! command -v kubectl &> /dev/null; then
                            echo "kubectl not found, installing..."
                            curl -LO "https://dl.k8s.io/release/v1.22.0/bin/linux/amd64/kubectl"
                            chmod +x ./kubectl
                            mv ./kubectl /usr/local/bin/kubectl
                        else
                            echo "kubectl is already installed."
                        fi

                        # Install Minikube
                        if ! command -v minikube &> /dev/null; then
                            echo "Minikube not found, installing..."
                            curl -LO "https://storage.googleapis.com/minikube/releases/v1.23.2/minikube-linux-amd64"
                            chmod +x minikube-linux-amd64
                            mv minikube-linux-amd64 /usr/local/bin/minikube
                        else
                            echo "Minikube is already installed."
                        fi

                        # Verify installations
                        kubectl version --client || echo "kubectl installation failed"
                        minikube version || echo "Minikube installation failed"
                    '''
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    sh '''
                        # Build Docker image
                        docker build -t ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} .

                        # Verify Docker image build
                        docker images | grep ${DOCKER_IMAGE_NAME}
                    '''
                }
            }
        }

        stage('Deploy to Minikube') {
            steps {
                script {
                    sh '''
                        # Start Minikube
                        minikube start

                        # Deploy to Minikube
                        kubectl apply -f k8s/deployment.yaml
                    '''
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
